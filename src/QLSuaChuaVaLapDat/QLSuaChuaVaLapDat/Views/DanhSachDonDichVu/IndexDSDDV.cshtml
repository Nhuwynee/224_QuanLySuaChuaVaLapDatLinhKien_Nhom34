@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
    Layout = null;
}

@* @model List<QLSuaChuaVaLapDat.Models.DonDichVuViewModel> *@
@model QLSuaChuaVaLapDat.Models.viewmodel.DonDichVuPagedViewModel



<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <base href="/" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto|Varela+Round">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="/css/dsddv.css" asp-append-version="true"/>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <title>Tổng quan thống kê - Quản lý cửa hàng</title>
</head>

<body>
    <div class="page d-flex">
        <div class="sidebar bg-dark text-white">
            <div class="top-row ps-4 navbar" style="background-color: #2A83E9;">
                <div class="container-fluid" style="background-image: url(/images/logoDMX.png); height: 50px; background-size: contain; background-repeat: no-repeat;">
                </div>

            </div>

            <input type="checkbox" title="Navigation menu" class="navbar-toggler d-none" />

            <div class="nav-scrollable">
                <nav class="nav flex-column">
                    <div class="nav-item px-0">
                        <a class="nav-link text-white " asp-controller="DanhSachDangKy" asp-action="IndexDSDK" style="font-size: 18px;">
                            <i class="fa-solid fa-table-list " style="color: #FFD43B; margin-right: 10px;"></i>
                            Danh sách đăng ký
                        </a>
                    </div>
                    <div class="nav-item px-0">
                        <a class="nav-link text-white active-menu" asp-controller="DanhSachDonDichVu" asp-action="IndexDSDDV" style="font-size: 18px;">
                            <i class="fa-solid fa-list" style="color: #74C0FC; margin-right: 10px;"></i>
                            Danh sách đơn
                        </a>
                    </div>

                </nav>
            </div>
        </div>

        <main class="flex-grow-1">
            <!-- header -->
            <div class="top-row shadow-sm" style="display: flex; align-items: center; justify-content: space-around; padding: 10px; background-color: #2A83E9;">
                <div class="d-flex align-items-center">
                    <!-- <img src="/testUI/images_test/logoDMX.png" alt="Logo" height="40px" class="d-inline-block align-text-top me-2"> -->
                    <!-- <h5 class="mb-0 text-success">Cửa hàng của bạn</h5> -->
                    <div class="slogan">Mua sắm tiện lợi, Sửa chữa chuyên nghiệp, Lắp đặt tận tâm"</div>
                </div>

                <div class="d-flex align-items-center">
                    <div class="search-box me-3" style="margin-right: 10px;">
                        <div class="input-group">
                            <input type="text" class="form-control" placeholder="Tìm kiếm..." aria-label="Search">
                            <div class="input-group-append">
                                <button class="btn btn-outline-light" type="button">
                                    <i class="fa fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="dropdown me-3" style="margin-right: 10px;">
                        <button class="btn btn-light dropdown-toggle" type="button" id="notificationDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <i class="fa-solid fa-bell text-secondary"></i>
                            <span class="badge badge-danger">3</span>
                        </button>
                        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="notificationDropdown">
                            <a class="dropdown-item" href="#">Có 5 đơn hàng mới</a>
                            <a class="dropdown-item" href="#">2 sản phẩm sắp hết hàng</a>
                            <a class="dropdown-item" href="#">Cập nhật phiên bản mới</a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item text-center" href="#">Xem tất cả</a>
                        </div>
                    </div>

                    <div class="user-info d-flex align-items-center">
                        <div class="avatar me-2">
                            <img src="/images/defaultavatar.png" alt="User Avatar" class="rounded-circle" width="40" height="40">
                        </div>
                        <div class="user-details d-none d-sm-block">
                            <h6 class="mb-0 text-light">CSKH</h6>
                            <small class="text-light">Nguyễn Vũ Khanh</small>
                        </div>
                    </div>
                    <a id="logout" href="#" class="btn btn-danger btn-sm ms-3 text-light" style="margin-left: 30px;">
                        <i class="fa-solid fa-sign-out-alt me-1 "></i> Đăng xuất
                    </a>
                </div>
            </div>


            <!-- Main Content -->
            <div class="main-content">
                <h1 class="page-title">Danh sách đơn dịch vụ</h1>

                <div class="filter-bar">
                    <div class="filter-options">
                        <div class="search-filter">
                            <i class="fa-solid fa-magnifying-glass"></i>
                            <input type="text" placeholder="Tìm kiếm đơn dịch vụ...">
                        </div>

                        <!-- <div class="filter-group">
                            <div class="filter-label">Ngày</div>
                            <i class="fa-solid fa-chevron-down dropdown-icon"></i>
                        </div> -->

                        <div class="filter-group">
                            <div class="filter-label">Trạng thái</div>
                            <i class="fa-solid fa-chevron-down dropdown-icon"></i>
                        </div>
                    </div>
                </div>

                <div class="order-list">
                    <div class="list-header">
                        <div>Mã đơn</div>
                        <div>Khách hàng</div>
                        <div>Mô tả đơn dịch vụ</div>
                        <div>Trạng thái</div>
                        <div>Tiền đơn dịch vụ</div>
                        <div>Cập nhật</div>
                    </div>

                    @foreach (var item in Model.DonDichVus)
                    {
                        <div class="list-item">
                            <div>@item.MaDon</div>
                            <div>@item.TenKhachHang</div>
                            <div>@item.MoTa</div>
                            <div>
                                <span class="status-badge @(item.TrangThai == "Hoàn thành" ? "hoan-thanh" : "dang-tien-hanh")">
                                    @item.TrangThai
                                </span>
                            </div>
                            <div>@string.Format("{0:N0} VND", item.TongTien)</div>
                            <div class="action-buttons">
                                <i class="fa-solid fa-pen-to-square action-icon"></i>
                                <i class="fa-solid fa-trash delete-icon"></i>
                            </div>
                        </div>
                    }

                </div>
                @* <nav> *@
                @*     <ul class="pagination"> *@
                @*         @for (int i = 1; i <= Model.TotalPages; i++) *@
                @*         { *@
                @*             <li class="page-item @(i == Model.CurrentPage ? "active" : "")"> *@
                @*                 <a class="page-link" href="?page=@i">@i</a> *@
                @*             </li> *@
                @*         } *@
                @*     </ul> *@
                @* </nav> *@
                <div class="pagination-container">
                    <ul class="pagination">
                        @if (Model.CurrentPage > 1)
                        {
                            <li class="page-item">
                                <a class="page-link" href="@Url.Action("IndexDSDDV", "DanhSachDonDichVu", new { page = Model.CurrentPage - 1 })">Trước</a>
                            </li>
                        }

                        @for (int i = 1; i <= Model.TotalPages; i++)
                        {
                            <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                                <a class="page-link" href="@Url.Action("IndexDSDDV", "DanhSachDonDichVu", new { page = i })">@i</a>
                            </li>
                        }

                        @if (Model.CurrentPage < Model.TotalPages)
                        {
                            <li class="page-item">
                                <a class="page-link" href="@Url.Action("IndexDSDDV", "DanhSachDonDichVu", new { page = Model.CurrentPage + 1 })">Tiếp</a>
                            </li>
                        }
                    </ul>
                </div>

                <div style="display: flex; justify-content: flex-end;">
                    <button class="add-button" onclick = "confirmRedirect()">
                        <i class="fa-solid fa-plus add-icon"></i>
                        @* <a href="taodonsua.html" style="text-decoration: none; color: white;"> *@
                            Thêm đơn
                        @* </a> *@
                    </button>
                </div>
            </div>

            <!-- Modal for Service Order Details -->
            <div class="modal fade" id="orderDetailModal" tabindex="-1" role="dialog" aria-labelledby="orderDetailModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg" role="document">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title" id="orderDetailModalLabel"><i class="fa-solid fa-clipboard-list me-2"></i>Chi tiết đơn dịch vụ</h5>
                            <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <!-- Thông tin đơn hàng và tình trạng -->
                            <div class="order-status-section mb-4">
                                <div class="card mb-3">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0"><i class="fa-solid fa-info-circle me-2"></i>Thông tin cơ bản</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-group d-flex">
                                                    <label class="col-5 font-weight-bold">Mã đơn:</label>
                                                    <span id="detail-madon" class="col-7 text-primary font-weight-bold"></span>
                                                </div>
                                                <div class="form-group d-flex">
                                                    <label class="col-5 font-weight-bold">Trạng thái:</label>
                                                    <span id="detail-trangthai" class="col-7">
                                                        <span class="badge badge-pill" style="font-size: 90%"></span>
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group d-flex">
                                                    <label class="col-5 font-weight-bold">Tổng tiền:</label>
                                                    <span id="detail-tongtien" class="col-7 text-success font-weight-bold"></span>
                                                </div>
                                                <div class="form-group d-flex">
                                                    <label class="col-5 font-weight-bold">Phương thức thanh toán:</label>
                                                    <span id="detail-phuongthuc" class="col-7"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <!-- Thông tin khách hàng -->
                                <div class="col-md-6">
                                    <div class="card mb-3">
                                        <div class="card-header bg-light">
                                            <h6 class="mb-0"><i class="fa-solid fa-user me-2"></i>Thông tin khách hàng</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="form-group">
                                                <label class="font-weight-bold">Tên khách hàng:</label>
                                                <span id="detail-tenkhachhang"></span>
                                            </div>
                                            <div class="form-group">
                                                <label class="font-weight-bold">Loại khách hàng:</label>
                                                <span id="detail-loaikhachhang"></span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Thông tin thiết bị -->
                                    <div class="card mb-3">
                                        <div class="card-header bg-light">
                                            <h6 class="mb-0"><i class="fa-solid fa-laptop me-2"></i>Thông tin thiết bị</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="form-group">
                                                <label class="font-weight-bold">Tên thiết bị:</label>
                                                <span id="detail-tenthietbi"></span>
                                            </div>
                                            <div class="form-group">
                                                <label class="font-weight-bold">Loại thiết bị:</label>
                                                <span id="detail-loaithietbi"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Thông tin dịch vụ -->
                                <div class="col-md-6">
                                    <div class="card mb-3">
                                        <div class="card-header bg-light">
                                            <h6 class="mb-0"><i class="fa-solid fa-tools me-2"></i>Thông tin dịch vụ</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="form-group">
                                                <label class="font-weight-bold">Hình thức dịch vụ:</label>
                                                <span id="detail-hinhthuc"></span>
                                            </div>
                                            <div class="form-group">
                                                <label class="font-weight-bold">Loại đơn dịch vụ:</label>
                                                <span id="detail-loaidon"></span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Thông tin nhân viên xử lý -->
                                    <div class="card mb-3">
                                        <div class="card-header bg-light">
                                            <h6 class="mb-0"><i class="fa-solid fa-user-tie me-2"></i>Nhân viên xử lý</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="form-group">
                                                <label class="font-weight-bold">Nhân viên kỹ thuật:</label>
                                                <span id="detail-nvkythuat"></span>
                                            </div>
                                            <div class="form-group">
                                                <label class="font-weight-bold">Người tạo đơn:</label>
                                                <span id="detail-nguoitaodon"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Thông tin thời gian -->
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0"><i class="fa-solid fa-calendar-alt me-2"></i>Thông tin thời gian</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label class="font-weight-bold">Ngày tạo đơn:</label>
                                                <span id="detail-ngaytaodon"></span>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label class="font-weight-bold">Ngày hoàn thành:</label>
                                                <span id="detail-ngayhoanthanh"></span>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label class="font-weight-bold">Ngày chỉnh sửa:</label>
                                                <span id="detail-ngaychinhsua"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" id="editOrderBtn">
                                <i class="fa-solid fa-edit me-2"></i>Chỉnh sửa
                            </button>
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">
                                <i class="fa-solid fa-times me-2"></i>Đóng
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add this CSS for better styling -->
            <style>
                /* Modal styling */
                #orderDetailModal .modal-header {
                    background-color: #2A83E9;
                    border-radius: 0.3rem 0.3rem 0 0;
                }

                #orderDetailModal .modal-title {
                    color: white;
                    font-weight: 500;
                }

                #orderDetailModal .close {
                    color: white;
                    text-shadow: none;
                    opacity: 0.8;
                }

                    #orderDetailModal .close:hover {
                        opacity: 1;
                    }

                #orderDetailModal .card {
                    border-radius: 0.5rem;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
                    overflow: hidden;
                }

                #orderDetailModal .card-header {
                    border-bottom: 1px solid rgba(0,0,0,0.125);
                    padding: 0.75rem 1.25rem;
                }

                #orderDetailModal .form-group {
                    margin-bottom: 0.5rem;
                }

                #orderDetailModal label {
                    margin-bottom: 0.25rem;
                    color: #6c757d;
                }

                #orderDetailModal span:not(.badge) {
                    color: #212529;
                }

                /* Badge styling for status */
                #detail-trangthai .badge {
                    padding: 0.4rem 0.6rem;
                }

                @@media (max-width: 767.98px) {
                    #orderDetailModal .form-group.d-flex

                {
                    flex-direction: column;
                }

                #orderDetailModal .form-group.d-flex label,
                #orderDetailModal .form-group.d-flex span {
                    width: 100%;
                    max-width: 100%;
                    flex: 0 0 100%;
                }

                }
            </style>

            
        </main>
    </div>
    <script>
        function confirmRedirect() {
            const confirmResult = confirm("Bạn có muốn tạo đơn sửa chữa mới không?");
            if (confirmResult) {
                window.location.href = '@Url.Action("IndexTDDVKVL", "TaoDonDichVuKVL")';
            }
            // Ngược lại thì không làm gì cả
        }
</script>
    <!-- Add this JavaScript code to enhance the modal functionality -->
    <script>
        $(document).ready(function() {
            // Attach event listener to all action icons
            $('.action-icon').click(function() {
                // Get the service order ID from the parent list item
                var orderId = $(this).closest('.list-item').children().first().text();

                // Call AJAX to get order details
                $.ajax({
                    url: '@Url.Action("ChiTietDonDichVu", "DanhSachDonDichVu")',
                    type: 'GET',
                    data: { id: orderId },
                    success: function(data) {
                        // Format dates
                        var ngayTao = data.ngayTaoDon ? new Date(data.ngayTaoDon).toLocaleDateString('vi-VN') : 'N/A';
                        var ngayHoanThanh = data.ngayHoanThanh ? new Date(data.ngayHoanThanh).toLocaleDateString('vi-VN') : 'N/A';
                        var ngayChinhSua = data.ngayChinhSua ? new Date(data.ngayChinhSua).toLocaleDateString('vi-VN') : 'N/A';

                        // Format money
                        var tongTien = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(data.tongTien);

                        // Fill the modal with data
                        $('#detail-madon').text(data.maDon);
                        $('#detail-tenkhachhang').text(data.tenKhachHang);
                        $('#detail-loaikhachhang').text(data.loaiKhachHang);
                        $('#detail-ngaytaodon').text(ngayTao);
                        $('#detail-ngayhoanthanh').text(ngayHoanThanh);
                        $('#detail-nvkythuat').text(data.tenNhanVienKyThuat);
                        $('#detail-nguoitaodon').text(data.tenNguoiTaoDon);
                        $('#detail-tenthietbi').text(data.tenThietBi);
                        $('#detail-loaithietbi').text(data.loaiThietBi);
                        $('#detail-hinhthuc').text(data.hinhThucDichVu);
                        $('#detail-loaidon').text(data.loaiDonDichVu);
                        $('#detail-phuongthuc').text(data.phuongThucThanhToan || 'N/A');
                        $('#detail-tongtien').text(tongTien);

                        // Set status with appropriate badge color
                        var statusBadge = $('#detail-trangthai .badge');
                        statusBadge.text(data.trangThaiDon);

                        // Set badge color based on status
                        statusBadge.removeClass('badge-success badge-warning badge-danger badge-info');
                        if (data.trangThaiDon === 'Hoàn thành') {
                            statusBadge.addClass('badge-success');
                        } else if (data.trangThaiDon === 'Đang tiến hành') {
                            statusBadge.addClass('badge-warning');
                        } else if (data.trangThaiDon === 'Chờ xử lý') {
                            statusBadge.addClass('badge-info');
                        } else if (data.trangThaiDon === 'Hủy') {
                            statusBadge.addClass('badge-danger');
                        }

                        $('#detail-ngaychinhsua').text(ngayChinhSua);

                        // Show the modal
                        $('#orderDetailModal').modal('show');
                    },
                    error: function(error) {
                        console.error('Error loading order details:', error);
                        alert('Không thể tải thông tin chi tiết đơn dịch vụ. Vui lòng thử lại sau.');
                    }
                });
            });

            // Add event handler for edit button
            $('#editOrderBtn').click(function() {
                var orderId = $('#detail-madon').text();
                // Redirect to edit page or show edit modal
                window.location.href = '@Url.Action("", "DanhSachDonDichVu")/' + orderId;
            });

            // Add event handler for delete icon
            $('.delete-icon').click(function() {
                var orderId = $(this).closest('.list-item').children().first().text();
                if (confirm('Bạn có chắc chắn muốn xóa đơn dịch vụ này không?')) {
                    $.ajax({
                        url: '@Url.Action("XoaDonDichVu", "DanhSachDonDichVu")',
                        type: 'POST',
                        data: { id: orderId },
                        success: function(response) {
                            if (response.success) {
                                // Remove the element from the DOM
                                $('[data-id="' + orderId + '"]').remove();
                                // Reload the page to refresh the list
                                location.reload();
                            } else {
                                alert(response.message || 'Không thể xóa đơn dịch vụ. Vui lòng thử lại sau.');
                            }
                        },
                        error: function(error) {
                            console.error('Error deleting order:', error);
                            alert('Có lỗi xảy ra khi xóa đơn dịch vụ. Vui lòng thử lại sau.');
                        }
                    });
                }
            });
        });
    </script>

    </body>

</html>
